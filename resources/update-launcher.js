"use strict";var D=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var P=D((E,w)=>{var m=require("fs"),d=require("path"),p=d.join(__dirname,"path.txt");function I(){let e;if(m.existsSync(p)&&(e=m.readFileSync(p,"utf-8")),process.env.ELECTRON_OVERRIDE_DIST_PATH)return d.join(process.env.ELECTRON_OVERRIDE_DIST_PATH,e||"electron");if(e)return d.join(__dirname,"dist",e);throw new Error("Electron failed to install correctly, please delete node_modules/electron and try installing again")}w.exports=I()});var l=require("child_process"),c=require("fs"),S=require("path");var h=require("path"),b=require("os");function T(){let e=(0,b.userInfo)();return(0,h.join)(process.env.APPDATA||(process.platform==="darwin"?(0,h.join)(e.homedir,"Library","Application Support"):(0,h.join)(e.homedir,".config")),"RawaLite")}function y(){try{let{app:e}=P();return e.getPath("userData")}catch{return T()}}var $=y();try{(0,c.mkdirSync)($,{recursive:!0})}catch{}var x=(0,S.join)($,`update-launcher-${Date.now()}.log`);function t(e){let s=`[${new Date().toISOString()}] ${e}
`;console.log(s.trim());try{(0,c.writeFileSync)(x,s,{flag:"a"})}catch(a){console.error(`Fehler beim Schreiben des Logs: ${a}`)}}var g=process.argv.slice(2);g.length<2&&(t("\u274C Fehler: Parent-PID und Installer-Pfad m\xFCssen angegeben werden."),t("Verwendung: update-launcher.js <parent-pid> <installer-pfad> [options]"),process.exit(1));var u=parseInt(g[0],10),o=g[1],n={waitDelay:500,maxWaitTime:3e4,silent:!1,debug:!0};(isNaN(u)||u<=0)&&(t(`\u274C Fehler: Ung\xFCltige Parent-PID: ${u}`),process.exit(1));(0,c.existsSync)(o)||(t(`\u274C Fehler: Installer nicht gefunden: ${o}`),process.exit(1));for(let e=2;e<g.length;e++){let r=g[e];r==="--silent"&&(n.silent=!0),r==="--debug"&&(n.debug=!0),r.startsWith("--wait-delay=")&&(n.waitDelay=parseInt(r.split("=")[1],10)),r.startsWith("--max-wait=")&&(n.maxWaitTime=parseInt(r.split("=")[1],10)*1e3)}t("\u{1F680} RawaLite Update-Launcher gestartet");t(`\u{1F4CA} Konfiguration: ${JSON.stringify({installerPath:o,parentPid:u,options:n,logPath:x})}`);function R(e){return new Promise(r=>{try{try{process.kill(e,0),n.debug&&t(`\u{1F50D} Prozess ${e} l\xE4uft (signal check)`),r(!0)}catch{n.debug&&t(`\u{1F50D} Prozess ${e} beendet (signal check)`),r(!1)}}catch(s){process.platform==="win32"?(0,l.execFile)("tasklist",["/FI",`PID eq ${e}`,"/NH"],(a,i)=>{if(a)t(`\u26A0\uFE0F Fehler bei tasklist: ${a.message}`),r(!1);else{let f=i.toLowerCase().includes(e.toString());n.debug&&t(`\u{1F50D} Prozess ${e} l\xE4uft: ${f} (tasklist)`),r(f)}}):(t(`\u26A0\uFE0F Allgemeiner Fehler bei Prozesspr\xFCfung: ${s}`),r(!1))}})}async function A(e){t(`\u23F3 \xDCberwache Prozess ${e} bis zur Beendigung...`);let r=Date.now(),s=0;for(;;){if(!await R(e)){t(`\u2705 Prozess ${e} wurde beendet`);break}if(s=Date.now()-r,s>=n.maxWaitTime){t(`\u26A0\uFE0F Timeout nach ${s}ms. Fortfahren trotz laufendem Prozess.`);break}n.debug&&s%3e3<n.waitDelay&&t(`\u23F1\uFE0F Warte seit ${Math.round(s/1e3)}s auf Beendigung von Prozess ${e}`),await new Promise(i=>setTimeout(i,n.waitDelay))}}async function F(){t(`\u{1F680} Starte Update-Installer: ${o}`);try{return new Promise(e=>{(0,l.exec)(`"${o}"`,(r,s,a)=>{if(r){t(`\u26A0\uFE0F Standard-Start fehlgeschlagen: ${r.message}`),t("\u{1F504} Versuche Fallback mit PowerShell erh\xF6hte Rechte...");let i=(0,l.spawn)("powershell.exe",["-NoProfile","-ExecutionPolicy","Bypass","-Command",`Start-Process -FilePath "${o}" -Verb RunAs`],{detached:!0,stdio:"ignore",windowsHide:!n.debug});i.on("error",f=>{t(`\u274C PowerShell-Fallback fehlgeschlagen: ${f.message}`),e(!1)}),i.unref(),t("\u2705 Installer \xFCber PowerShell mit erh\xF6hten Rechten gestartet"),e(!0)}else t("\u2705 Installer erfolgreich direkt gestartet"),e(!0)})})}catch(e){return t(`\u274C Alle Startmethoden fehlgeschlagen: ${e}`),!1}}async function k(){t("\u23F3 Warte auf Beendigung der RawaLite-Anwendung...");try{await A(u),t("\u2705 RawaLite-Anwendung beendet. Warte noch 1 Sekunde f\xFCr Ressourcenfreigabe..."),await new Promise(r=>setTimeout(r,1e3)),await F()?(t("\u2705 Update-Launcher hat seine Aufgabe erf\xFCllt. Wird beendet."),setTimeout(()=>process.exit(0),1e3)):(t("\u274C Installer konnte nicht gestartet werden."),process.exit(1))}catch(e){t(`\u274C Unerwarteter Fehler im Update-Launcher: ${e}`),process.exit(1)}}k().catch(e=>{t(`\u274C Unerwarteter Fehler: ${e}`),process.exit(1)});
