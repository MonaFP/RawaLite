<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rechnung {{invoice.invoiceNumber}}</title>
  
  <!-- DIN 5008 compliant CSS for professional German business documents -->
  <style>
    @page {
      size: A4;
      margin: 2.5cm 2cm 2cm 2.5cm; /* DIN 5008: Links 2,5cm, rechts 2cm, oben 2,5cm, unten 2cm */
    }
    
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      font-size: 11pt; /* DIN 5008 Standard-Schriftgröße */
      line-height: 1.3;
      color: #000;
      margin: 0;
      padding: 0;
      background: white;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    /* DIN 5008 Briefkopf-Bereich */
    .letterhead {
      position: relative;
      height: 4.5cm; /* DIN 5008: Briefkopf bis 4,5cm */
      margin-bottom: 2cm;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .company-info {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      font-size: 9pt;
      color: #333;
    }
    
    .company-name {
      font-size: 14pt;
      font-weight: bold;
      color: #1e3a2e;
      margin-bottom: 0.3cm;
    }
    
    .company-details {
      line-height: 1.2;
    }
    
    .logo {
      position: absolute;
      top: 0;
      right: 0;
      max-width: 4cm;
      max-height: 2.5cm;
      object-fit: contain;
    }
    
    /* DIN 5008 Anschriftenfeld */
    .address-field {
      width: 8.5cm; /* DIN 5008: Anschriftenfeld 8,5cm breit */
      margin-bottom: 2cm;
      position: relative;
    }
    
    .sender-line {
      font-size: 8pt;
      color: #666;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.1cm;
      margin-bottom: 0.3cm;
      line-height: 1.1;
    }
    
    .recipient-address {
      font-size: 11pt;
      line-height: 1.2;
    }
    
    .recipient-name {
      font-weight: bold;
      margin-bottom: 0.2cm;
    }
    
    /* Informationsblock */
    .info-block {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5cm;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 0.5cm;
    }
    
    .info-left, .info-right {
      width: 48%;
    }
    
    .info-row {
      display: flex;
      margin-bottom: 0.2cm;
    }
    
    .info-label {
      width: 3.5cm;
      font-weight: bold;
      color: #333;
    }
    
    .info-value {
      flex: 1;
    }
    
    /* Dokumenttitel */
    .document-title {
      font-size: 16pt;
      font-weight: bold;
      color: #1e3a2e;
      margin: 1.5cm 0 1cm 0;
      text-align: left;
    }
    
    /* Ansprache und Einleitung */
    .salutation {
      margin-bottom: 1cm;
      line-height: 1.4;
    }
    
    /* Tabelle für Positionen */
    .positions-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5cm 0;
      border: 1px solid #d0d0d0;
      page-break-inside: auto;
    }
    
    .positions-table th,
    .positions-table td {
      padding: 0.4cm 0.3cm;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      border-right: 1px solid #e0e0e0;
      vertical-align: top;
      page-break-inside: avoid;
    }
    
    .positions-table thead {
      page-break-after: avoid;
    }
    
    .positions-table tr {
      page-break-inside: avoid;
    }
    
    .positions-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #1e3a2e;
      font-size: 10pt;
    }
    
    .positions-table td {
      font-size: 10pt;
    }
    
    .position-title {
      font-weight: bold;
      margin-bottom: 0.1cm;
    }
    
    .position-description {
      font-size: 9pt;
      color: #555;
      font-style: italic;
    }
    
    .sub-position {
      padding-left: 1cm;
      background-color: #fafafa;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    /* Summen-Bereich */
    .totals-section {
      margin-top: 1cm;
      display: flex;
      justify-content: flex-end;
      page-break-inside: avoid;
      margin-bottom: 1cm;
    }
    
    .totals-table {
      width: 6cm;
      border-collapse: collapse;
    }
    
    .totals-table td {
      padding: 0.2cm 0.3cm;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .totals-table .label {
      text-align: left;
      font-weight: normal;
    }
    
    .totals-table .amount {
      text-align: right;
      font-weight: bold;
    }
    
    .total-final {
      border-top: 2px solid #1e3a2e;
      font-size: 12pt;
      font-weight: bold;
      color: #1e3a2e;
    }
    
    /* Steuerhinweis */
    .tax-note {
      font-size: 9pt;
      color: #666;
      font-style: italic;
      margin-top: 0.5cm;
    }
    
    /* Zahlungshinweise */
    .payment-info {
      margin: 1.5cm 0;
      padding: 0.5cm;
      background-color: #f8f9fa;
      border-left: 4px solid #1e3a2e;
      line-height: 1.4;
    }
    
    .payment-title {
      font-weight: bold;
      color: #1e3a2e;
      margin-bottom: 0.5cm;
    }
    
    /* Schlusstext */
    .closing-text {
      margin: 1.5cm 0;
      line-height: 1.4;
    }
    
    /* Anmerkungen */
    .notes-section {
      margin-top: 2cm;
      padding-top: 0.5cm;
      border-top: 1px solid #e0e0e0;
    }
    
    .notes-title {
      font-weight: bold;
      color: #1e3a2e;
      margin-bottom: 0.5cm;
    }
    
    .notes-content {
      line-height: 1.4;
      white-space: pre-wrap;
    }
    
    /* Footer für Geschäftsangaben */
    .business-footer {
      margin-top: 3cm;
      font-size: 8pt;
      color: #666;
      line-height: 1.2;
      border-top: 1px solid #e0e0e0;
      padding-top: 0.3cm;
      page-break-inside: avoid;
    }
    
    /* Status-Indicator */
    .status-indicator {
      position: absolute;
      top: 1cm;
      right: 0;
      padding: 0.3cm 0.5cm;
      border-radius: 0.2cm;
      font-size: 10pt;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .status-draft {
      background-color: #fef3c7;
      color: #92400e;
      border: 1px solid #fbbf24;
    }
    
    .status-sent {
      background-color: #dbeafe;
      color: #1e40af;
      border: 1px solid #3b82f6;
    }
    
    .status-paid {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #22c55e;
    }
    
    .status-overdue {
      background-color: #fee2e2;
      color: #dc2626;
      border: 1px solid #ef4444;
    }
    
    /* Print-spezifische Anpassungen */
    @media print {
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .positions-table th {
        background-color: #f8f9fa !important;
      }
      
      .sub-position {
        background-color: #fafafa !important;
      }
      
      .payment-info {
        background-color: #f8f9fa !important;
      }
      
      .status-indicator {
        display: none; /* Status nicht in gedruckter Version anzeigen */
      }
    }
    
    /* Responsive Anpassungen für Vorschau */
    @media screen and (max-width: 21cm) {
      body {
        padding: 1cm;
      }
      
      .address-field {
        width: 100%;
        max-width: 8.5cm;
      }
      
      .info-block {
        flex-direction: column;
      }
      
      .info-left, .info-right {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Status-Indikator (nur in Vorschau) -->
  <div class="status-indicator status-{{invoice.status}}">
    {{#if (eq invoice.status 'draft')}}Entwurf{{/if}}
    {{#if (eq invoice.status 'sent')}}Versendet{{/if}}
    {{#if (eq invoice.status 'paid')}}Bezahlt{{/if}}
    {{#if (eq invoice.status 'overdue')}}Überfällig{{/if}}
  </div>
  
  <!-- Briefkopf nach DIN 5008 -->
  <div class="letterhead">
    <div class="company-info">
      <div class="company-name">{{company.name}}</div>
      <div class="company-details">
        {{company.street}}<br>
        {{company.zip}} {{company.city}}<br>
        {{#if company.phone}}Tel: {{company.phone}}<br>{{/if}}
        {{#if company.email}}E-Mail: {{company.email}}<br>{{/if}}
        {{#if company.website}}Web: {{company.website}}{{/if}}
      </div>
    </div>
    {{#if company.logo}}
    <img src="{{company.logo}}" alt="{{company.name}} Logo" class="logo">
    {{/if}}
  </div>
  
  <!-- Anschriftenfeld nach DIN 5008 -->
  <div class="address-field">
    <div class="sender-line">
      {{company.name}} · {{company.street}} · {{company.zip}} {{company.city}}
    </div>
    <div class="recipient-address">
      <div class="recipient-name">{{customer.name}}</div>
      {{#if customer.street}}{{customer.street}}<br>{{/if}}
      {{#if customer.zip}}{{customer.zip}} {{customer.city}}{{/if}}
    </div>
  </div>
  
  <!-- Informationsblock -->
  <div class="info-block">
    <div class="info-left">
      <div class="info-row">
        <span class="info-label">Rechnungs-Nr.:</span>
        <span class="info-value">{{invoice.invoiceNumber}}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Rechnungsdatum:</span>
        <span class="info-value">{{formatDate invoice.createdAt}}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Fälligkeitsdatum:</span>
        <span class="info-value">{{formatDate invoice.dueDate}}</span>
      </div>
      {{#if customer.email}}
      <div class="info-row">
        <span class="info-label">E-Mail:</span>
        <span class="info-value">{{customer.email}}</span>
      </div>
      {{/if}}
    </div>
    <div class="info-right">
      {{#if invoice.offerId}}
      <div class="info-row">
        <span class="info-label">Angebot-Nr.:</span>
        <span class="info-value">{{invoice.offerId}}</span>
      </div>
      {{/if}}
      {{#if customer.phone}}
      <div class="info-row">
        <span class="info-label">Telefon:</span>
        <span class="info-value">{{customer.phone}}</span>
      </div>
      {{/if}}
      {{#if customer.number}}
      <div class="info-row">
        <span class="info-label">Kunden-Nr.:</span>
        <span class="info-value">{{customer.number}}</span>
      </div>
      {{/if}}
    </div>
  </div>
  
  <!-- Dokumenttitel -->
  <h1 class="document-title">Rechnung</h1>
  
  <!-- Ansprache -->
  <div class="salutation">
    <p>Sehr geehrte Damen und Herren,</p>
    <p>für erbrachte Leistungen erlauben wir uns, Ihnen folgende Positionen in Rechnung zu stellen:</p>
  </div>
  
  <!-- Betreff -->
  {{#if invoice.title}}
  <div style="margin-bottom: 1cm;">
    <strong>Betreff: {{invoice.title}}</strong>
  </div>
  {{/if}}
  
  <!-- Positionen-Tabelle -->
  <table class="positions-table">
    <thead>
      <tr>
        <th style="width: 50%;">Position</th>
        <th style="width: 10%;" class="text-center">Menge</th>
        <th style="width: 20%;" class="text-right">Einzelpreis (€)</th>
        <th style="width: 20%;" class="text-right">Gesamtpreis (€)</th>
      </tr>
    </thead>
    <tbody>
      {{#each invoice.lineItems}}
      <tr {{#if this.parentItemId}}class="sub-position"{{/if}}>
        <td>
          <div class="position-title">
            {{#if this.parentItemId}}↳ {{/if}}{{this.title}}
          </div>
          {{#if this.description}}
          <div class="position-description">{{this.description}}</div>
          {{/if}}
        </td>
        <td class="text-center">{{this.quantity}}</td>
        <td class="text-right">{{formatCurrency this.unitPrice}}</td>
        <td class="text-right">{{formatCurrency this.total}}</td>
      </tr>
      {{/each}}
    </tbody>
  </table>
  
  <!-- Summen-Bereich -->
  <div class="totals-section">
    <table class="totals-table">
      <tr>
        <td class="label">Zwischensumme:</td>
        <td class="amount">{{formatCurrency invoice.subtotal}}</td>
      </tr>
      {{#unless company.kleinunternehmer}}
      {{#if invoice.vatAmount}}
      <tr>
        <td class="label">MwSt. ({{invoice.vatRate}}%):</td>
        <td class="amount">{{formatCurrency invoice.vatAmount}}</td>
      </tr>
      {{/if}}
      {{/unless}}
      <tr class="total-final">
        <td class="label">Rechnungsbetrag:</td>
        <td class="amount">{{formatCurrency invoice.total}}</td>
      </tr>
    </table>
  </div>
  
  <!-- Steuerhinweis bei Kleinunternehmer -->
  {{#if company.kleinunternehmer}}
  <div class="tax-note">
    Gemäß § 19 UStG wird keine Umsatzsteuer ausgewiesen.
  </div>
  {{/if}}
  
  <!-- Zahlungshinweise -->
  <div class="payment-info">
    <div class="payment-title">Zahlungshinweise:</div>
    <div>
      Bitte überweisen Sie den Rechnungsbetrag bis zum {{formatDate invoice.dueDate}} auf unten angegebenes Konto.<br>
      {{#if company.bankName}}
      <strong>Bank:</strong> {{company.bankName}}<br>
      {{/if}}
      {{#if company.bankAccount}}
      <strong>IBAN:</strong> {{company.bankAccount}}<br>
      {{/if}}
      {{#if company.bankBic}}
      <strong>BIC:</strong> {{company.bankBic}}<br>
      {{/if}}
      <strong>Verwendungszweck:</strong> {{invoice.invoiceNumber}}
    </div>
  </div>
  
  <!-- Anmerkungen -->
  {{#if invoice.notes}}
  <div class="notes-section">
    <div class="notes-title">Anmerkungen:</div>
    <div class="notes-content">{{invoice.notes}}</div>
  </div>
  {{/if}}
  
  <!-- Schlusstext -->
  <div class="closing-text">
    <p>Vielen Dank für Ihr Vertrauen und die gute Zusammenarbeit.</p>
    <p>Bei Fragen stehen wir Ihnen gerne zur Verfügung.</p>
  </div>
  
  <!-- Grußformel -->
  <div style="margin-top: 2cm;">
    <p>Mit freundlichen Grüßen</p>
    <div style="margin-top: 1.5cm;">
      {{company.name}}
    </div>
  </div>
  
  <!-- Geschäftsangaben im Footer -->
  <div class="business-footer">
    <div style="text-align: center;">
      <strong>{{company.name}}</strong> · {{company.street}} · {{company.zip}} {{company.city}}<br>
      {{#if company.phone}}Tel: {{company.phone}}{{/if}}
      {{#if company.email}} · E-Mail: {{company.email}}{{/if}}
      {{#if company.website}} · Web: {{company.website}}{{/if}}<br>
      {{#if company.taxId}}Steuernummer: {{company.taxId}}{{/if}}
      {{#if company.vatId}} · USt-IdNr.: {{company.vatId}}{{/if}}
      {{#if company.bankName}} · {{company.bankName}}{{/if}}
      {{#if company.bankAccount}} · IBAN: {{company.bankAccount}}{{/if}}
      {{#if company.bankBic}} · BIC: {{company.bankBic}}{{/if}}
    </div>
  </div>
</body>
</html>