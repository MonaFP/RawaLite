/**
 * TEST COVERAGE: DatabaseConfigurationService.getActiveConfig()
 * 
 * Gemäß Original-Plan Phase 6: Testing & Rollback Plan
 * 
 * Tests:
 * - returns correct configuration for all theme-navigation-focus combinations
 * - respects user overrides and preferences  
 * - falls back correctly when data missing
 * - merges configurations in correct priority order
 * 
 * @since Phase 6 - Testing & Rollback Plan
 */

import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';
import { DatabaseConfigurationService } from '../src/services/DatabaseConfigurationService';
import { DatabaseNavigationService } from '../src/services/DatabaseNavigationService';
import { DatabaseThemeService } from '../src/services/DatabaseThemeService';
import type { ActiveConfiguration } from '../src/services/DatabaseConfigurationService';
import type { NavigationMode } from '../src/services/DatabaseNavigationService';

// Mock dependencies
vi.mock('../src/services/DatabaseNavigationService');
vi.mock('../src/services/DatabaseThemeService');

describe('DatabaseConfigurationService.getActiveConfig()', () => {
  let configurationService: DatabaseConfigurationService;
  let mockDb: any;
  
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Create mock database
    mockDb = {};
    
    // Create service instance
    configurationService = new DatabaseConfigurationService(mockDb);
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  // PHASE 6 REQUIREMENT: Test all theme-navigation-focus combinations
  describe('Configuration Combinations', () => {
    const themes = ['sage', 'dark', 'sky'];
    const navigationModes: NavigationMode[] = ['header-statistics', 'header-navigation', 'full-sidebar'];
    const focusModes = [true, false];

    themes.forEach(theme => {
      navigationModes.forEach(navigationMode => {
        focusModes.forEach(focusMode => {
          test(`returns correct config for ${theme}-${navigationMode}-${focusMode ? 'focus' : 'normal'}`, async () => {
            // Arrange
            const userId = 'test-user';
            
            // Act
            const config = await configurationService.getActiveConfig(
              userId, 
              theme, 
              navigationMode, 
              focusMode
            );

            // Assert
            expect(config).toBeDefined();
            expect(config.theme).toBe(theme);
            expect(config.navigationMode).toBe(navigationMode);
            expect(config.focusMode).toBe(focusMode);
            
            // Verify SYSTEM_DEFAULTS are respected
            const expectedHeaders = {
              'header-statistics': 160,
              'header-navigation': 160,
              'full-sidebar': 72
            };
            expect(config.headerHeight).toBe(expectedHeaders[navigationMode]);
            
            // Verify CSS variables are generated
            expect(config.cssVariables).toBeDefined();
            expect(config.cssVariables['--db-header-height']).toBe(`${config.headerHeight}px`);
            expect(config.cssVariables['--db-sidebar-width']).toBe(`${config.sidebarWidth}px`);
          });
        });
      });
    });
  });

  // PHASE 6 REQUIREMENT: Test user overrides and preferences
  describe('User Preferences Priority', () => {
    test('respects user navigation preferences', async () => {
      // Arrange
      const userId = 'user-with-prefs';
      const mockUserPrefs = {
        navigationMode: 'header-navigation' as NavigationMode,
        headerHeight: 180, // Custom value
        sidebarWidth: 300,  // Custom value
        autoCollapse: true,
        rememberFocusMode: false
      };

      vi.mocked(DatabaseNavigationService.prototype.getUserNavigationPreferences)
        .mockResolvedValue(mockUserPrefs);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId, 
        'sage', 
        'header-navigation', 
        false
      );

      // Assert
      expect(config.headerHeight).toBe(180); // User override
      expect(config.sidebarWidth).toBe(300); // User override
    });

    test('respects mode-specific settings', async () => {
      // Arrange
      const userId = 'user-with-mode-settings';
      const mockModeSettings = {
        navigationMode: 'full-sidebar' as NavigationMode,
        headerHeight: 80, // Mode-specific override
        sidebarWidth: 260,
        autoCollapseMobile: true,
        gridTemplateColumns: '260px 1fr'
      };

      vi.mocked(DatabaseNavigationService.prototype.getModeSpecificSettings)
        .mockResolvedValue(mockModeSettings);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'full-sidebar',
        false
      );

      // Assert
      expect(config.headerHeight).toBe(80); // Mode-specific override
      expect(config.sidebarWidth).toBe(260);
      expect(config.gridTemplateColumns).toBe('260px 1fr');
    });

    test('respects focus mode preferences', async () => {
      // Arrange
      const userId = 'user-with-focus-prefs';
      const mockFocusPrefs = {
        navigationMode: 'header-statistics' as NavigationMode,
        hideSidebarInFocus: true,
        hideHeaderStatsInFocus: true,
        dimBackgroundOpacity: 0.5
      };

      vi.mocked(DatabaseNavigationService.prototype.getFocusModePreferences)
        .mockResolvedValue(mockFocusPrefs);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-statistics',
        true // Focus mode enabled
      );

      // Assert  
      expect(config.focusMode).toBe(true);
      // Focus-specific modifications should be applied
      expect(config.cssVariables['--focus-sidebar-opacity']).toBeDefined();
    });

    test('respects theme overrides', async () => {
      // Arrange
      const userId = 'user-with-theme-overrides';
      const mockThemeOverrides = [{
        property: 'primaryColor',
        value: '#custom-green'
      }];

      vi.mocked(DatabaseThemeService.prototype.getThemeOverrides)
        .mockResolvedValue(mockThemeOverrides);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        false
      );

      // Assert
      expect(config.primaryColor).toBe('#custom-green'); // Theme override
    });
  });

  // PHASE 6 REQUIREMENT: Test fallback behavior
  describe('Fallback Handling', () => {
    test('falls back to system defaults when user data missing', async () => {
      // Arrange
      const userId = 'new-user';
      
      // Mock all data sources returning null
      vi.mocked(DatabaseNavigationService.prototype.getUserNavigationPreferences)
        .mockResolvedValue(null);
      vi.mocked(DatabaseThemeService.prototype.getUserThemePreference)
        .mockResolvedValue(null);
      vi.mocked(DatabaseNavigationService.prototype.getModeSpecificSettings)
        .mockResolvedValue(null);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        false
      );

      // Assert - Should use SYSTEM_DEFAULTS
      expect(config.headerHeight).toBe(160); // SYSTEM_DEFAULTS.HEADER_HEIGHTS['header-navigation']
      expect(config.sidebarWidth).toBe(280); // SYSTEM_DEFAULTS.SIDEBAR_WIDTHS['header-navigation'] 
      expect(config.theme).toBe('sage');
      expect(config.navigationMode).toBe('header-navigation');
    });

    test('handles database errors gracefully', async () => {
      // Arrange
      const userId = 'error-user';
      
      vi.mocked(DatabaseNavigationService.prototype.getUserNavigationPreferences)
        .mockRejectedValue(new Error('Database connection failed'));

      // Act & Assert - Should not throw
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        false
      );

      expect(config).toBeDefined();
      expect(config.configurationSource.headerHeight).toBe('emergency'); // Emergency fallback
    });

    test('falls back correctly for invalid navigation mode', async () => {
      // Arrange
      const userId = 'test-user';
      
      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'invalid-mode' as NavigationMode,
        false
      );

      // Assert - Should default to header-statistics
      expect(config.navigationMode).toBe('header-statistics');
      expect(config.headerHeight).toBe(160);
    });
  });

  // PHASE 6 REQUIREMENT: Test merge priority order
  describe('Configuration Merge Priority', () => {
    test('merges configurations in correct priority order', async () => {
      // Arrange
      const userId = 'priority-test-user';
      
      // Setup conflicting values across all sources
      const mockUserPrefs = { headerHeight: 100, sidebarWidth: 200 };
      const mockModeSettings = { headerHeight: 120, sidebarWidth: 220 };
      const mockFocusSettings = { headerHeight: 140, sidebarWidth: 240 };
      
      vi.mocked(DatabaseNavigationService.prototype.getUserNavigationPreferences)
        .mockResolvedValue(mockUserPrefs);
      vi.mocked(DatabaseNavigationService.prototype.getModeSpecificSettings)
        .mockResolvedValue(mockModeSettings);
      vi.mocked(DatabaseNavigationService.prototype.getFocusModePreferences)
        .mockResolvedValue(mockFocusSettings);

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        true // Focus mode - highest priority
      );

      // Assert - Focus settings should win (highest priority)
      expect(config.headerHeight).toBe(140); // From focus settings
      expect(config.sidebarWidth).toBe(240); // From focus settings
    });

    test('cascade priority: Focus > Mode > User > Theme > System', async () => {
      // Arrange
      const userId = 'cascade-test-user';
      
      // Only provide some sources to test cascade
      const mockUserPrefs = { headerHeight: 100 }; // No sidebar width
      const mockModeSettings = { sidebarWidth: 220 }; // No header height
      
      vi.mocked(DatabaseNavigationService.prototype.getUserNavigationPreferences)
        .mockResolvedValue(mockUserPrefs);
      vi.mocked(DatabaseNavigationService.prototype.getModeSpecificSettings)
        .mockResolvedValue(mockModeSettings);
      vi.mocked(DatabaseNavigationService.prototype.getFocusModePreferences)
        .mockResolvedValue(null); // No focus settings

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage', 
        'header-navigation',
        false
      );

      // Assert
      expect(config.headerHeight).toBe(100); // From user prefs
      expect(config.sidebarWidth).toBe(220); // From mode settings
    });
  });

  // PHASE 6 REQUIREMENT: Test CSS variable generation
  describe('CSS Variable Generation', () => {
    test('generates all required CSS variables', async () => {
      // Arrange
      const userId = 'css-test-user';

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        false
      );

      // Assert - Verify all CSS variables are present
      const requiredVars = [
        '--db-header-height',
        '--db-sidebar-width', 
        '--db-grid-template-rows',
        '--db-grid-template-columns',
        '--db-theme-primary',
        '--db-theme-secondary',
        '--db-theme-accent',
        '--db-theme-background',
        '--db-theme-text'
      ];

      requiredVars.forEach(varName => {
        expect(config.cssVariables[varName]).toBeDefined();
      });
    });

    test('generates focus-specific CSS variables when in focus mode', async () => {
      // Arrange
      const userId = 'focus-css-test-user';

      // Act
      const config = await DatabaseConfigurationService.getActiveConfig(
        userId,
        'sage',
        'header-navigation',
        true // Focus mode
      );

      // Assert - Focus-specific variables should be present
      const focusVars = [
        '--focus-dim-opacity',
        '--focus-transition-duration',
        '--focus-sidebar-opacity'
      ];

      focusVars.forEach(varName => {
        expect(config.cssVariables[varName]).toBeDefined();
      });
    });
  });

  // PHASE 6 REQUIREMENT: Performance and caching tests
  describe('Performance & Caching', () => {
    test('caches results for same parameters', async () => {
      // Arrange
      const userId = 'cache-test-user';
      const theme = 'sage';
      const navigationMode = 'header-navigation';
      const focusMode = false;

      // Act - Call twice with same parameters
      const config1 = await DatabaseConfigurationService.getActiveConfig(userId, theme, navigationMode, focusMode);
      const config2 = await DatabaseConfigurationService.getActiveConfig(userId, theme, navigationMode, focusMode);

      // Assert - Should use cache for second call
      expect(config1).toEqual(config2);
      // Verify database was only called once (implementation detail)
    });

    test('invalidates cache when configuration updated', async () => {
      // Arrange
      const userId = 'cache-invalidation-user';

      // Act - Get config, update it, get again
      const config1 = await DatabaseConfigurationService.getActiveConfig(userId, 'sage', 'header-navigation', false);
      
      await DatabaseConfigurationService.updateActiveConfig(userId, { headerHeight: 200 });
      
      const config2 = await DatabaseConfigurationService.getActiveConfig(userId, 'sage', 'header-navigation', false);

      // Assert - Should have updated value
      expect(config2.headerHeight).toBe(200);
      expect(config1.headerHeight).not.toBe(config2.headerHeight);
    });
  });
});

/**
 * ROLLBACK PLAN TESTS - Phase 6 Requirement
 */
describe('Rollback Plan Validation', () => {
  test('feature flag disables central configuration', async () => {
    // Arrange
    process.env.ENABLE_CENTRAL_CONFIG = 'false';

    // Act - Should fallback to legacy methods
    const result = await DatabaseConfigurationService.getActiveConfig('user', 'sage', 'header-navigation', false);

    // Assert - Should indicate fallback was used
    expect(result.configurationSource.headerHeight).toBe('legacy');
  });

  test('components can fallback to old methods', async () => {
    // This would be tested in integration tests
    // Verify NavigationContext and DatabaseThemeManager work with both old and new methods
    expect(true).toBe(true); // Placeholder for integration test
  });
});

/**
 * TEST UTILITIES
 */
export const createMockConfiguration = (overrides = {}): ActiveConfiguration => ({
  headerHeight: 160,
  sidebarWidth: 280,
  gridTemplateRows: '160px 40px 1fr',
  gridTemplateColumns: '280px 1fr',
  theme: 'sage',
  themeId: 4,
  primaryColor: '#7ba87b',
  secondaryColor: '#5a735a',
  accentColor: '#6b976b',
  backgroundColor: '#fbfcfb',
  textColor: '#2d4a2d',
  focusMode: false,
  navigationMode: 'header-navigation',
  isCompactMode: false,
  cssVariables: {
    '--db-header-height': '160px',
    '--db-sidebar-width': '280px',
    '--db-theme-primary': '#7ba87b'
  },
  configurationSource: {
    headerHeight: 'system',
    sidebarWidth: 'system',
    theme: 'system'
  },
  ...overrides
});

/**
 * RUN TESTS:
 * 
 * npm test tests/DatabaseConfigurationService.test.ts
 * 
 * COVERAGE:
 * npm run test:coverage -- tests/DatabaseConfigurationService.test.ts
 * 
 * CI INTEGRATION:
 * Add to .github/workflows/test.yml
 */