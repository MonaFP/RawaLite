"use strict";var F=Object.create;var P=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var U=(r,a)=>()=>(a||r((a={exports:{}}).exports,a),a.exports);var z=(r,a,e,l)=>{if(a&&typeof a=="object"||typeof a=="function")for(let o of _(a))!E.call(r,o)&&o!==e&&P(r,o,{get:()=>a[o],enumerable:!(l=k(a,o))||l.enumerable});return r};var W=(r,a,e)=>(e=r!=null?F(L(r)):{},z(a||!r||!r.__esModule?P(e,"default",{value:r,enumerable:!0}):e,r));var $=U((H,S)=>{var b=require("fs"),p=require("path"),y=p.join(__dirname,"path.txt");function N(){let r;if(b.existsSync(y)&&(r=b.readFileSync(y,"utf-8")),process.env.ELECTRON_OVERRIDE_DIST_PATH)return p.join(process.env.ELECTRON_OVERRIDE_DIST_PATH,r||"electron");if(r)return p.join(__dirname,"dist",r);throw new Error("Electron failed to install correctly, please delete node_modules/electron and try installing again")}S.exports=N()});var f=require("child_process"),h=require("fs"),D=require("path");var d=require("path"),x=require("os");function O(){let r=(0,x.userInfo)();return(0,d.join)(process.env.APPDATA||(process.platform==="darwin"?(0,d.join)(r.homedir,"Library","Application Support"):(0,d.join)(r.homedir,".config")),"RawaLite")}async function w(){try{let{app:r}=await Promise.resolve().then(()=>W($(),1));return r.getPath("userData")}catch{return O()}}(async()=>{let r=await w();try{(0,h.mkdirSync)(r,{recursive:!0})}catch{}let a=(0,D.join)(await w(),`update-launcher-${Date.now()}.log`);function e(t){let i=`[${new Date().toISOString()}] ${t}
`;console.log(i.trim());try{(0,h.writeFileSync)(a,i,{flag:"a"})}catch(u){console.error(`Fehler beim Schreiben des Logs: ${u}`)}}let l=process.argv.slice(2);l.length<2&&(e("\u274C Fehler: Parent-PID und Installer-Pfad m\xFCssen angegeben werden."),e("Verwendung: update-launcher.js <parent-pid> <installer-pfad> [options]"),process.exit(1));let o=parseInt(l[0],10),c=l[1],s={waitDelay:500,maxWaitTime:3e4,silent:!1,debug:!0};(isNaN(o)||o<=0)&&(e(`\u274C Fehler: Ung\xFCltige Parent-PID: ${o}`),process.exit(1)),(0,h.existsSync)(c)||(e(`\u274C Fehler: Installer nicht gefunden: ${c}`),process.exit(1));for(let t=2;t<l.length;t++){let n=l[t];n==="--silent"&&(s.silent=!0),n==="--debug"&&(s.debug=!0),n.startsWith("--wait-delay=")&&(s.waitDelay=parseInt(n.split("=")[1],10)),n.startsWith("--max-wait=")&&(s.maxWaitTime=parseInt(n.split("=")[1],10)*1e3)}e("\u{1F680} RawaLite Update-Launcher gestartet"),e(`\u{1F4CA} Konfiguration: ${JSON.stringify({installerPath:c,parentPid:o,options:s,logPath:a})}`);function I(t){return new Promise(n=>{try{try{process.kill(t,0),s.debug&&e(`\u{1F50D} Prozess ${t} l\xE4uft (signal check)`),n(!0)}catch{s.debug&&e(`\u{1F50D} Prozess ${t} beendet (signal check)`),n(!1)}}catch(i){process.platform==="win32"?(0,f.execFile)("tasklist",["/FI",`PID eq ${t}`,"/NH"],(u,g)=>{if(u)e(`\u26A0\uFE0F Fehler bei tasklist: ${u.message}`),n(!1);else{let m=g.toLowerCase().includes(t.toString());s.debug&&e(`\u{1F50D} Prozess ${t} l\xE4uft: ${m} (tasklist)`),n(m)}}):(e(`\u26A0\uFE0F Allgemeiner Fehler bei Prozesspr\xFCfung: ${i}`),n(!1))}})}async function T(t){e(`\u23F3 \xDCberwache Prozess ${t} bis zur Beendigung...`);let n=Date.now(),i=0;for(;;){if(!await I(t)){e(`\u2705 Prozess ${t} wurde beendet`);break}if(i=Date.now()-n,i>=s.maxWaitTime){e(`\u26A0\uFE0F Timeout nach ${i}ms. Fortfahren trotz laufendem Prozess.`);break}s.debug&&i%3e3<s.waitDelay&&e(`\u23F1\uFE0F Warte seit ${Math.round(i/1e3)}s auf Beendigung von Prozess ${t}`),await new Promise(g=>setTimeout(g,s.waitDelay))}}async function R(){e(`\u{1F680} Starte Update-Installer: ${c}`);try{return new Promise(t=>{(0,f.exec)(`"${c}"`,(n,i,u)=>{if(n){e(`\u26A0\uFE0F Standard-Start fehlgeschlagen: ${n.message}`),e("\u{1F504} Versuche Fallback mit PowerShell erh\xF6hte Rechte...");let g=(0,f.spawn)("powershell.exe",["-NoProfile","-ExecutionPolicy","Bypass","-Command",`Start-Process -FilePath "${c}" -Verb RunAs`],{detached:!0,stdio:"ignore",windowsHide:!s.debug});g.on("error",m=>{e(`\u274C PowerShell-Fallback fehlgeschlagen: ${m.message}`),t(!1)}),g.unref(),e("\u2705 Installer \xFCber PowerShell mit erh\xF6hten Rechten gestartet"),t(!0)}else e("\u2705 Installer erfolgreich direkt gestartet"),t(!0)})})}catch(t){return e(`\u274C Alle Startmethoden fehlgeschlagen: ${t}`),!1}}async function A(){e("\u23F3 Warte auf Beendigung der RawaLite-Anwendung...");try{await T(o),e("\u2705 RawaLite-Anwendung beendet. Warte noch 1 Sekunde f\xFCr Ressourcenfreigabe..."),await new Promise(n=>setTimeout(n,1e3)),await R()?(e("\u2705 Update-Launcher hat seine Aufgabe erf\xFCllt. Wird beendet."),setTimeout(()=>process.exit(0),1e3)):(e("\u274C Installer konnte nicht gestartet werden."),process.exit(1))}catch(t){e(`\u274C Unerwarteter Fehler im Update-Launcher: ${t}`),process.exit(1)}}A().catch(t=>{e(`\u274C Unerwarteter Fehler: ${t}`),process.exit(1)})})();
