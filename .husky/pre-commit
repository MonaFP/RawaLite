#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# 1. Lint and format staged files
echo "üìè Linting and formatting staged files..."
npx lint-staged

# 2. TypeScript type checking
echo "üîß Type checking..."
pnpm typecheck

# 3. Quick unit tests (only if test files were changed)
STAGED_FILES=$(git diff --cached --name-only)
if echo "$STAGED_FILES" | grep -qE "\.(test|spec)\.(ts|tsx)$"; then
  echo "üß™ Running unit tests (test files changed)..."
  pnpm test --run --reporter=basic
fi

# 4. Check commit message format
echo "üìù Validating commit message format..."
COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .+"; then
    echo "‚ùå Commit message doesn't follow conventional format:"
    echo "Current: $COMMIT_MSG"
    echo ""
    echo "Expected format: type(scope): description"
    echo "Examples:"
    echo "- feat(customers): add email validation to customer form"
    echo "- fix(db): resolve SQLite transaction deadlock"  
    echo "- docs(api): update persistence adapter documentation"
    exit 1
  fi
fi

# 5. Documentation sync check for source changes
if echo "$STAGED_FILES" | grep -qE "^src/|^electron/"; then
  echo "üîç Source code changes detected - checking documentation sync..."
  
  # Check if docs are also being updated
  if ! echo "$STAGED_FILES" | grep -qE "(docs/|README\.md|PROJECT_OVERVIEW\.md)"; then
    echo "‚ö†Ô∏è  Source code changes detected but no documentation updates staged."
    echo ""
    echo "Consider updating documentation if you've:"
    echo "- Added new features or APIs"
    echo "- Changed existing functionality"
    echo "- Modified architecture or patterns"
    echo "- Updated dependencies or configuration"
    echo ""
    echo "Relevant documentation files:"
    echo "- docs/standards.md (coding standards/patterns)"
    echo "- docs/debugging.md (error handling/debugging)"  
    echo "- docs/WORKFLOWS.md (processes/workflows)"
    echo "- docs/ARCHITEKTUR.md (architecture changes)"
    echo "- PROJECT_OVERVIEW.md (features/structure)"
    echo ""
    echo "If no docs need updating, you can proceed with this commit."
  fi
fi

echo "‚úÖ Pre-commit checks passed!"