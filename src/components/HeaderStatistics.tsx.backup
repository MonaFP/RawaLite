import React from 'react';
import { NavLink, useLocation } from 'react-router-dom';
import { useUnifiedSettings } from '../hooks/useUnifiedSettings';
import { useCustomers } from '../hooks/useCustomers';
import { useOffers } from '../hooks/useOffers';
import { useInvoices } from '../hooks/useInvoices';
import { useTheme } from '../hooks/useTheme';

interface HeaderStatisticsProps {
  title?: string;
}

export const HeaderStatistics: React.FC<HeaderStatisticsProps> = ({ title }) => {
  const location = useLocation();
  const { settings } = useUnifiedSettings();
  const { customers } = useCustomers();
  const { offers } = useOffers();
  const { invoices } = useInvoices();
  const { 
    getThemedPageTitle, 
    isLoading, 
    error,
    headerConfig,
    companyConfig,
    statisticsConfig 
  } = useTheme();
  
  // Dynamic title with theme integration
  const getPageTitle = () => {
    if (title) return title;
    return getThemedPageTitle(location.pathname);
  };

  // Statistics calculations
  const stats = {
    customers: customers?.length || 0,
    offers: offers?.length || 0,
    invoices: invoices?.length || 0,
    totalRevenue: invoices?.reduce((sum, invoice) => {
      const total = parseFloat(invoice.total?.toString() || '0');
      return sum + (isNaN(total) ? 0 : total);
    }, 0) || 0
  };

  // Loading and error handling for theme
  if (isLoading) {
    return (
      <div 
        className="header-statistics"
        style={{ backgroundColor: headerConfig.bgColor }}
      >
        <div 
          className="company-section"
          style={{ color: headerConfig.textColor }}
        >
          Loading theme...
        </div>
      </div>
    );
  }

  if (error) {
    console.warn('Theme loading error:', error);
    // Continue with fallback theme
  }

  return (
    <div className="header-statistics">
      <div className="company-section">
        <div className="company-info">
          <div 
            className="company-name"
            style={{
              color: companyConfig.nameColor,
              fontWeight: companyConfig.nameWeight
            }}
          >
            {settings.companyData?.name || 'Firma'}
          </div>
          
          {settings.companyData?.logo ? (
            <img 
              src={settings.companyData.logo} 
              alt="Company Logo" 
              className="company-logo"
            />
          ) : (
            <div 
              className="company-logo" 
              style={{
                background: 'rgba(255,255,255,0.2)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '18px',
                fontWeight: 'bold',
                color: companyConfig.nameColor,
                width: '40px',
                height: '40px',
                borderRadius: '8px'
              }}
            >
              G
            </div>
          )}
        </div>
        
        <div 
          className="page-title"
          style={{ color: headerConfig.textColor }}
        >
          {getPageTitle()}
        </div>
      </div>

      <div className="stats-cards">
        <div 
          className="stat-card"
          style={{
            backgroundColor: statisticsConfig.cardBg,
            border: `1px solid ${statisticsConfig.cardBorder}`,
            color: statisticsConfig.cardText
          }}
        >
          <div className="stat-icon">üë•</div>
          <div className="stat-content">
            <div 
              className="stat-value"
              style={{ color: statisticsConfig.cardValue }}
            >
              {stats.customers}
            </div>
            <div 
              className="stat-label"
              style={{ color: statisticsConfig.cardText }}
            >
              Kunden
            </div>
          </div>
        </div>

        <div 
          className="stat-card"
          style={{
            backgroundColor: statisticsConfig.cardBg,
            border: `1px solid ${statisticsConfig.cardBorder}`,
            color: statisticsConfig.cardText
          }}
        >
          <div className="stat-icon">üìù</div>
          <div className="stat-content">
            <div 
              className="stat-value"
              style={{ color: statisticsConfig.cardValue }}
            >
              {stats.offers}
            </div>
            <div 
              className="stat-label"
              style={{ color: statisticsConfig.cardText }}
            >
              Angebote
            </div>
          </div>
        </div>

        <div 
          className="stat-card"
          style={{
            backgroundColor: statisticsConfig.cardBg,
            border: `1px solid ${statisticsConfig.cardBorder}`,
            color: statisticsConfig.cardText
          }}
        >
          <div className="stat-icon">üí∞</div>
          <div className="stat-content">
            <div 
              className="stat-value"
              style={{ color: statisticsConfig.cardValue }}
            >
              {stats.invoices}
            </div>
            <div 
              className="stat-label"
              style={{ color: statisticsConfig.cardText }}
            >
              Rechnungen
            </div>
          </div>
        </div>

        <div 
          className="stat-card"
          style={{
            backgroundColor: statisticsConfig.cardBg,
            border: `1px solid ${statisticsConfig.cardBorder}`,
            color: statisticsConfig.cardText
          }}
        >
          <div className="stat-icon">üí∏</div>
          <div className="stat-content">
            <div 
              className="stat-value"
              style={{ 
                color: stats.totalRevenue > 10000 
                  ? statisticsConfig.successColor 
                  : stats.totalRevenue > 5000 
                    ? statisticsConfig.warningColor 
                    : statisticsConfig.dangerColor 
              }}
            >
              {new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
              }).format(stats.totalRevenue)}
            </div>
            <div 
              className="stat-label"
              style={{ color: statisticsConfig.cardText }}
            >
              Umsatz
            </div>
          </div>
        </div>
      </div>

      <div className="quick-nav">
        <NavLink
          to="/kunden"
          className={location.pathname === '/kunden' ? 'nav-button active' : 'nav-button'}
          title="Kunden verwalten"
          style={{
            backgroundColor: location.pathname === '/kunden' 
              ? 'rgba(255,255,255,0.3)' 
              : 'rgba(255,255,255,0.1)',
            color: headerConfig.textColor,
            border: `1px solid ${headerConfig.borderColor}`
          }}
        >
          üë•
        </NavLink>
        
        <NavLink
          to="/angebote"
          className={location.pathname.startsWith('/angebote') ? 'nav-button active' : 'nav-button'}
          title="Angebote verwalten"
          style={{
            backgroundColor: location.pathname.startsWith('/angebote') 
              ? 'rgba(255,255,255,0.3)' 
              : 'rgba(255,255,255,0.1)',
            color: headerConfig.textColor,
            border: `1px solid ${headerConfig.borderColor}`
          }}
        >
          üìù
        </NavLink>
        
        <NavLink
          to="/rechnungen"
          className={location.pathname === '/rechnungen' ? 'nav-button active' : 'nav-button'}
          title="Rechnungen verwalten"
          style={{
            backgroundColor: location.pathname === '/rechnungen' 
              ? 'rgba(255,255,255,0.3)' 
              : 'rgba(255,255,255,0.1)',
            color: headerConfig.textColor,
            border: `1px solid ${headerConfig.borderColor}`
          }}
        >
          üí∞
        </NavLink>

        <NavLink
          to="/einstellungen"
          className={location.pathname === '/einstellungen' ? 'nav-button active' : 'nav-button'}
          title="Einstellungen"
          style={{
            backgroundColor: location.pathname === '/einstellungen' 
              ? 'rgba(255,255,255,0.3)' 
              : 'rgba(255,255,255,0.1)',
            color: headerConfig.textColor,
            border: `1px solid ${headerConfig.borderColor}`
          }}
        >
          ‚öôÔ∏è
        </NavLink>
      </div>
    </div>
  );
};
