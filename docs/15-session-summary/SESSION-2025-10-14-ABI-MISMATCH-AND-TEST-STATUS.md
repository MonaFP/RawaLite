# ABI MISMATCH & TEST-STATUS BERICHT - 2025-10-14

## üî¥ **PROBLEM 1: ABI Mismatch im Terminal**

### **Fehler:**
```
‚ùå Database error: The module was compiled against a different Node.js version using
NODE_MODULE_VERSION 125. This version of Node.js requires NODE_MODULE_VERSION 127.
```

### **ROOT CAUSE:**

| Komponente | Version | ABI Version | Runtime |
|------------|---------|-------------|---------|
| **Node.js (System)** | v22.18.0 | **127** | ‚úÖ Kommandozeile |
| **better-sqlite3 (kompiliert)** | v12.4.1 | **125** | ‚ùå F√ºr Electron |
| **Electron (App)** | v31.7.7 | **125** | ‚úÖ In der App |

**Problem:**
- `inspect-real-db.mjs` wird mit **Node.js v22** ausgef√ºhrt
- `better-sqlite3` wurde f√ºr **Electron v31** kompiliert
- **Native Module** k√∂nnen NICHT zwischen verschiedenen Runtimes geteilt werden

---

### **WARUM DAS PASSIERT:**

**1. Zwei verschiedene JavaScript-Runtimes:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Node.js v22.18.0 (ABI 127)            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Kommandozeilen-Scripts            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ inspect-real-db.mjs ‚ùå            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Test-Scripts (vitest)             ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ Build-Scripts (esbuild, vite)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Electron v31.7.7 (ABI 125)            ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Main Process                       ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ Renderer Process                   ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ RawaLite App ‚úÖ                   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ better-sqlite3 (f√ºr Electron)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**2. Post-Install Rebuild:**
```json
// package.json
"postinstall": "node scripts/rebuild-native-electron.cjs"
```

**Das Script kompiliert better-sqlite3 f√ºr Electron:**
```bash
electron-rebuild -f -w better-sqlite3 --target=31.7.7
```

**Ergebnis:**
- ‚úÖ `better-sqlite3` funktioniert **IN der App** (Electron)
- ‚ùå `better-sqlite3` funktioniert **NICHT** in Node.js-Scripts

---

## ‚úÖ **L√ñSUNG: SQL.js f√ºr Node.js-Scripts verwenden**

### **Warum SQL.js?**
- ‚úÖ Pure JavaScript (keine Native Bindings)
- ‚úÖ Funktioniert in **Node.js UND Electron**
- ‚úÖ Read-only Access (perfekt f√ºr Inspection)
- ‚úÖ Bereits im Projekt (`sql.js` dependency)
- ‚úÖ Keine ABI-Probleme

### **Neues Script erstellen:**

```bash
# Datei: inspect-real-db-sqljs.mjs
node inspect-real-db-sqljs.mjs
```

**Code:**
```javascript
import initSqlJs from 'sql.js';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';
import os from 'os';

const dbPath = join(os.homedir(), 'AppData', 'Roaming', 'Electron', 'database', 'rawalite.db');

console.log('üîç Real Database Inspector (SQL.js)');
console.log(`üìÇ Database path: ${dbPath}`);

if (!existsSync(dbPath)) {
  console.log('‚ùå Database not found!');
  process.exit(1);
}

try {
  const SQL = await initSqlJs();
  const buffer = readFileSync(dbPath);
  const db = new SQL.Database(buffer);
  
  console.log('‚úÖ Database loaded successfully');
  
  // Schema version
  const version = db.exec('PRAGMA user_version')[0].values[0][0];
  console.log(`üìä Schema version: ${version}`);
  
  // List tables
  const tables = db.exec(`SELECT name FROM sqlite_master WHERE type='table' ORDER BY name`);
  console.log('\nüìã Tables:');
  tables[0].values.forEach(row => console.log(`   - ${row[0]}`));
  
  // package_line_items schema
  console.log('\nüéØ package_line_items schema:');
  const schema = db.exec('PRAGMA table_info(package_line_items)');
  schema[0].values.forEach(col => {
    console.log(`   ${col[1]}: ${col[2]} ${col[3] ? 'NOT NULL' : ''} ${col[5] ? 'PK' : ''}`);
  });
  
  // Count
  const count = db.exec('SELECT COUNT(*) FROM package_line_items')[0].values[0][0];
  console.log(`\nüìä Count: ${count}`);
  
  // Sample data
  if (count > 0) {
    console.log('\nüìÑ Sample:');
    const samples = db.exec(`
      SELECT id, title, quantity, unit_price, parent_item_id 
      FROM package_line_items LIMIT 5
    `);
    samples[0].values.forEach(row => {
      console.log(`   ID ${row[0]}: ${row[1]} - Qty: ${row[2]}, Price: ${row[3]}, Parent: ${row[4] || 'none'}`);
    });
  }
  
  db.close();
  console.log('\n‚úÖ Complete');
  
} catch (error) {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
}
```

**Vorteile:**
- ‚úÖ Kein ABI-Mismatch
- ‚úÖ Funktioniert sofort
- ‚úÖ Keine Rebuild-Probleme
- ‚úÖ Gleiche API wie better-sqlite3

---

## üîß **PROBLEM 2: Test-Status**

### **Test-Ergebnisse:**

| Status | Count | Tests |
|--------|-------|-------|
| ‚úÖ **PASS** | 27 | v1041-fix, GitHubApiService, e2e, CriticalPatterns (4/5) |
| ‚ùå **FAIL** | 5 | CriticalPatterns (1/5 Port), 4x File-Not-Found |

---

### **‚ùå Fehlgeschlagene Tests (Details):**

#### **1. CriticalPatterns.test.ts - Port Consistency**

**Fehler:**
```typescript
// Test erwartet:
win.loadURL('http://localhost:5174')

// Aber main.ts hat:
createWindow() // ‚Üê Funktion extrahiert, kein direkter loadURL
```

**ROOT CAUSE:**
- Test pr√ºft **alten Code-Pattern** (vor IPC Refactoring)
- Nach Refactoring ist `loadURL` in `windows/main-window.ts`
- Test liest `electron/main.ts`, aber Pattern dort nicht mehr

**FIX NEEDED:**
```typescript
// Option 1: Test anpassen
const windowSourceCode = fs.readFileSync('electron/windows/main-window.ts', 'utf8');
expect(windowSourceCode).toMatch(/win\.loadURL\('http:\/\/localhost:5174'\)/);

// Option 2: Test erweitern
const mainSourceCode = fs.readFileSync('electron/main.ts', 'utf8');
const windowSourceCode = fs.readFileSync('electron/windows/main-window.ts', 'utf8');
const hasPort = mainSourceCode.includes('5174') || windowSourceCode.includes('5174');
expect(hasPort).toBe(true);
```

---

#### **2-5. File-Not-Found Errors**

**Fehlermeldungen:**
```
‚ùå Failed to load url ../src/main/db/BackupService
‚ùå Failed to load url ../src/services/DbClient
‚ùå Failed to load url ../src/main/db/MigrationService
‚ùå Failed to load url ../src/services/NummernkreisService.ts
```

**ROOT CAUSE:**
- Tests verweisen auf **nicht-existierende Dateien**
- Nach Projekt-Refactoring wurden Pfade/Namen ge√§ndert
- Test-Imports nicht aktualisiert

**Aktuelle Struktur pr√ºfen:**
```bash
# Was existiert wirklich?
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îî‚îÄ‚îÄ db/
‚îÇ       ‚îú‚îÄ‚îÄ Database.ts ‚úÖ
‚îÇ       ‚îú‚îÄ‚îÄ MigrationService.ts ‚ùì
‚îÇ       ‚îî‚îÄ‚îÄ BackupService.ts ‚ùì
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ DbClient.ts ‚ùì
‚îÇ   ‚îî‚îÄ‚îÄ NummernkreisService.ts ‚ùì
‚îî‚îÄ‚îÄ renderer/
    ‚îî‚îÄ‚îÄ services/
        ‚îî‚îÄ‚îÄ SQLiteAdapter.ts ‚úÖ
```

**FIX NEEDED:**
1. **Pfade korrigieren** oder
2. **Tests deaktivieren** (falls Services nicht mehr existieren) oder
3. **Fehlende Services wiederherstellen**

---

### **‚úÖ Erfolgreiche Tests:**

#### **1. v1041-fix.test.ts (10 Tests) ‚úÖ**
- UpdateTelemetryService: 4/4 ‚úÖ
- ReleaseHygieneValidator: 3/3 ‚úÖ
- Integration Tests: 3/3 ‚úÖ

#### **2. GitHubApiService.test.ts (12 Tests) ‚úÖ**
- API Calls, Rate Limiting, Error Handling

#### **3. e2e/app.test.ts (1 Test) ‚úÖ**
- Playwright E2E

#### **4. CriticalPatterns.test.ts (4/5) ‚úÖ**
- WriteStream Promise Pattern ‚úÖ
- File System Flush Delay ‚úÖ
- Single Event Handler ‚úÖ
- Port Consistency in vite.config ‚úÖ
- Port Consistency in main.ts ‚ùå (siehe oben)

---

## üìä **TEST-STATUS ZUSAMMENFASSUNG**

### **Kategorisierung:**

| Kategorie | Status | Tests | Anmerkung |
|-----------|--------|-------|-----------|
| **Update System** | ‚úÖ PASS | v1041-fix (10) | Voll funktional |
| **API Services** | ‚úÖ PASS | GitHubApiService (12) | Voll funktional |
| **E2E** | ‚úÖ PASS | app.test (1) | Voll funktional |
| **Critical Fixes** | ‚ö†Ô∏è 4/5 | CriticalPatterns | 1 Test veraltet |
| **Database** | ‚ùå FAIL | BackupService, DbClient, MigrationService | File-Not-Found |
| **Services** | ‚ùå FAIL | NummernkreisService | File-Not-Found |

**Score:** 27 PASS / 5 FAIL = **84% Success Rate**

---

## üéØ **HANDLUNGSEMPFEHLUNGEN**

### **üî¥ KRITISCH (sofort):**

#### **1. inspect-real-db-sqljs.mjs erstellen**
```bash
# Neues Script mit SQL.js
node inspect-real-db-sqljs.mjs  # ‚úÖ Kein ABI-Mismatch
```

**Priorit√§t:** HOCH  
**Aufwand:** 5 Minuten  
**Impact:** L√∂st ABI-Problem vollst√§ndig

---

### **üü° WICHTIG (kurzfristig):**

#### **2. CriticalPatterns Port-Test reparieren**

**Option A: Test erweitern (EMPFOHLEN)**
```typescript
// tests/critical-fixes/CriticalPatterns.test.ts
it('CRITICAL: Port Consistency in electron/main.ts', () => {
  const mainCode = fs.readFileSync('electron/main.ts', 'utf8');
  const windowCode = fs.readFileSync('electron/windows/main-window.ts', 'utf8');
  
  // Port muss in einem der beiden Files sein
  const hasPort5174 = mainCode.includes('5174') || windowCode.includes('5174');
  expect(hasPort5174).toBe(true);
  
  // Oder in vite.config.mts
  const viteConfig = fs.readFileSync('vite.config.mts', 'utf8');
  expect(viteConfig).toMatch(/port:\s*5174/);
});
```

**Priorit√§t:** MITTEL  
**Aufwand:** 10 Minuten  
**Impact:** 100% Test-Success

---

#### **3. Fehlende Services pr√ºfen**

**Schritt 1: Existenz pr√ºfen**
```bash
# Suche nach Services
find src -name "*BackupService*"
find src -name "*DbClient*"
find src -name "*MigrationService*"
find src -name "*NummernkreisService*"
```

**Schritt 2: Entscheidung treffen**

**Falls Services EXISTIEREN:**
```typescript
// Test-Imports korrigieren
import { BackupService } from '../../src/main/db/BackupService'; // ‚úÖ Korrekter Pfad
```

**Falls Services NICHT EXISTIEREN:**
```typescript
// Tests deaktivieren oder entfernen
describe.skip('BackupService', () => { /* ... */ });
```

**Priorit√§t:** MITTEL  
**Aufwand:** 30 Minuten (Recherche + Fix)  
**Impact:** 84% ‚Üí 100% Test-Success

---

### **üü¢ OPTIONAL (langfristig):**

#### **4. Test-Struktur dokumentieren**
```markdown
# tests/README.md

## Test-Kategorien
- ‚úÖ Update System (v1041-fix)
- ‚úÖ API Services (GitHubApiService)
- ‚úÖ E2E (app.test)
- ‚ö†Ô∏è Critical Patterns (1 Test veraltet)
- ‚ùå Database Services (File-Not-Found)

## Bekannte Issues
- CriticalPatterns Port-Test: Nach IPC Refactoring veraltet
- Database Service Tests: Pfade nach Refactoring falsch
```

**Priorit√§t:** NIEDRIG  
**Aufwand:** 15 Minuten  
**Impact:** Bessere Wartbarkeit

---

## üîç **DETAILLIERTE ANALYSE: Warum ABI-Mismatches normal sind**

### **Node.js ABI-Versionen:**

| Node.js Version | ABI | Status |
|-----------------|-----|--------|
| v16.x | 93 | Old |
| v18.x | 108 | LTS |
| v20.x | 115 | LTS |
| **v22.x** | **127** | **Aktuell** |

### **Electron ABI-Versionen:**

| Electron Version | Node.js embedded | ABI |
|------------------|------------------|-----|
| v28.x | Node.js 18.x | 108 |
| v29.x | Node.js 20.x | 115 |
| v30.x | Node.js 20.x | 115 |
| **v31.x** | **Node.js 20.x** | **125** |

**Wichtig:**
- Electron v31 nutzt **Node.js 20** (intern)
- System hat **Node.js 22** installiert
- **125 vs. 127** = Inkompatibel

---

### **Warum better-sqlite3 betroffen ist:**

**Native Addons:**
```
better-sqlite3
‚îú‚îÄ‚îÄ JavaScript-Wrapper (kompatibel)
‚îî‚îÄ‚îÄ better_sqlite3.node (Native C++)
    ‚îî‚îÄ‚îÄ Kompiliert f√ºr SPECIFIC ABI ‚ùå
```

**Pure JavaScript Packages:**
```
sql.js
‚îî‚îÄ‚îÄ Kompiliertes WASM (universell) ‚úÖ
```

**Deshalb:**
- `better-sqlite3` ‚Üí ABI-abh√§ngig ‚ùå
- `sql.js` ‚Üí ABI-unabh√§ngig ‚úÖ

---

## üìã **ACTIONABLE CHECKLISTE**

### **Sofort (heute):**
- [ ] `inspect-real-db-sqljs.mjs` erstellen
- [ ] ABI-Mismatch Problem dokumentiert als "by design"
- [ ] Altes `inspect-real-db.mjs` umbenennen zu `.backup`

### **Diese Woche:**
- [ ] CriticalPatterns Port-Test reparieren
- [ ] Fehlende Services recherchieren
- [ ] Test-Imports korrigieren oder Tests deaktivieren

### **Optional:**
- [ ] Test-Dokumentation erstellen
- [ ] CI/CD anpassen (falls ABI-Fehler dort auftreten)
- [ ] Andere Node.js-Scripts auf SQL.js migrieren

---

## üí° **LESSONS LEARNED**

### **1. Native Addons vs. WASM:**
- ‚úÖ **WASM (sql.js):** Universal, keine ABI-Probleme
- ‚ùå **Native (better-sqlite3):** Schneller, aber ABI-abh√§ngig

### **2. Electron ‚â† Node.js:**
- Electron bringt **eigene Node.js-Version** mit
- System-Node.js ist **separate Installation**
- Native Module m√ºssen **spezifisch kompiliert** werden

### **3. Test-Maintenance:**
- Tests m√ºssen nach **Refactorings aktualisiert** werden
- File-Not-Found Errors = **Veraltete Imports**
- Critical Pattern Tests m√ºssen **Architektur-√Ñnderungen** ber√ºcksichtigen

### **4. Best Practices:**
- **Node.js-Scripts:** SQL.js oder andere Pure-JS Libraries
- **Electron-App:** better-sqlite3 (Performance)
- **Tests:** Mocks oder In-Memory DBs

---

## üìö **REFERENZEN**

### **Betroffene Dateien:**
- `inspect-real-db.mjs` (ABI-Problem) ‚Üí Ersetzen durch `-sqljs.mjs`
- `tests/critical-fixes/CriticalPatterns.test.ts` (Port-Test veraltet)
- `tests/database/*.test.ts` (File-Not-Found)
- `tests/services/NummernkreisService.test.ts` (File-Not-Found)

### **Relevante Scripts:**
- `scripts/rebuild-native-electron.cjs` - Kompiliert f√ºr Electron
- `scripts/check-electron-abi.cjs` - Pr√ºft ABI-Kompatibilit√§t
- `package.json` - postinstall Hooks

### **Dokumentation:**
- Node.js ABI Versions: https://nodejs.org/en/download/releases
- Electron Versions: https://www.electronjs.org/docs/latest/tutorial/electron-versioning
- Native Addons: https://nodejs.org/api/addons.html

---

**üí° Zusammenfassung:**
1. ‚úÖ ABI-Mismatch ist **NORMAL** (Node.js 22 vs. Electron 31)
2. ‚úÖ L√∂sung: **SQL.js** f√ºr Node.js-Scripts verwenden
3. ‚ö†Ô∏è Tests: **4 File-Not-Found** + **1 veralteter Pattern-Test**
4. üìä Test-Score: **84%** ‚Üí Mit Fixes **100%** erreichbar
